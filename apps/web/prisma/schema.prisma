// ============================================================
// EVENT-LUX â€” Prisma Schema
// Database: PostgreSQL via Supabase
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  SUPERADMIN
  ADMIN
  USER
}

enum EventCategory {
  TECH
  CULTURAL
  SPORTS
  ACADEMIC
  WORKSHOP
  HACKATHON
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  ATTENDED
  NO_SHOW
}

// ============================================================
// MODELS
// ============================================================

model University {
  id          String   @id @default(cuid())
  name        String   @unique
  shortCode   String   @unique // e.g. "MIT", "BITS"
  logoUrl     String?
  website     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  admins      User[]
  events      Event[]

  @@map("universities")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  avatarUrl      String?
  phone          String?
  role           Role      @default(USER)
  isActive       Boolean   @default(true)
  emailVerified  Boolean   @default(false)

  // Password auth
  passwordHash   String?

  // OAuth
  googleId       String?   @unique
  githubId       String?   @unique

  // University link (for ADMIN role)
  universityId   String?
  university     University? @relation(fields: [universityId], references: [id])

  // Timestamps
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  registrations  Registration[]
  createdEvents  Event[]         @relation("EventCreator")
  sessions       Session[]
  notifications  Notification[]

  // SUPERADMIN constraint: enforced at application level (max 2)
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("sessions")
}

model Event {
  id               String        @id @default(cuid())
  title            String
  slug             String        @unique
  description      String        @db.Text
  shortDescription String?       @db.VarChar(300)
  bannerUrl        String?
  thumbnailUrl     String?

  // Categorization
  category         EventCategory
  tags             String[]      @default([])

  // Timing
  startDate        DateTime
  endDate          DateTime
  registrationDeadline DateTime?

  // Location
  venue            String?
  venueAddress     String?
  isOnline         Boolean       @default(false)
  onlineLink       String?

  // Capacity
  maxAttendees     Int?
  currentAttendees Int           @default(0)

  // Pricing
  isFree           Boolean       @default(true)
  price            Decimal?      @db.Decimal(10, 2)

  // Status
  status           EventStatus   @default(DRAFT)
  isFeatured       Boolean       @default(false)

  // Relations
  universityId     String
  university       University    @relation(fields: [universityId], references: [id])
  createdById      String
  createdBy        User          @relation("EventCreator", fields: [createdById], references: [id])

  registrations    Registration[]
  googleSheetSync  GoogleSheetSync?

  // Timestamps
  publishedAt      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([category])
  @@index([universityId])
  @@index([status])
  @@index([startDate])
  @@map("events")
}

model Registration {
  id         String             @id @default(cuid())
  userId     String
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId    String
  event      Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)

  status     RegistrationStatus @default(PENDING)

  // QR Ticketing
  ticketCode String             @unique @default(cuid())
  qrCodeUrl  String?
  checkedInAt DateTime?

  // Form data (from Google Forms / custom)
  formData   Json?

  // Payment (future-proof)
  paymentId  String?
  paidAt     DateTime?

  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  // A user can only register once per event
  @@unique([userId, eventId])
  @@index([eventId])
  @@index([userId])
  @@index([ticketCode])
  @@map("registrations")
}

model GoogleSheetSync {
  id             String    @id @default(cuid())
  eventId        String    @unique
  event          Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  spreadsheetId  String
  sheetName      String    @default("Sheet1")
  formUrl        String?

  // Sync config
  isAutoSync     Boolean   @default(false)
  syncIntervalMin Int      @default(15)  // minutes between auto-syncs
  lastSyncAt     DateTime?
  lastSyncStatus String?   // "success" | "error"
  lastSyncError  String?

  columnMapping  Json?     // Maps sheet columns to Registration fields

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("google_sheet_syncs")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title     String
  message   String
  type      String   // "event_reminder" | "registration_confirmed" | "ticket_ready" | "system"
  isRead    Boolean  @default(false)
  metadata  Json?    // e.g. { eventId, ticketCode }

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}
