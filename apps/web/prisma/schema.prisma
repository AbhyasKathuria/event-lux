// ============================================================
// EVENT-LUX â€” Prisma Schema
// Database: PostgreSQL via Supabase
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  SUPERADMIN
  ADMIN
  USER
}

enum EventCategory {
  TECH
  CULTURAL
  SPORTS
  ACADEMIC
  WORKSHOP
  HACKATHON
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  ATTENDED
  NO_SHOW
}

// ============================================================
// MODELS
// ============================================================

model University {
  id          String   @id @default(cuid())
  name        String   @unique
  shortCode   String   @unique
  logoUrl     String?
  website     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  admins      User[]
  events      Event[]

  @@map("universities")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String
  avatarUrl       String?
  phone           String?
  role            Role      @default(USER)
  isActive        Boolean   @default(true)
  emailVerified   Boolean   @default(false)

  // Password auth - Field name matches auth.ts and registration logic
  password        String?

  // OAuth
  googleId        String?   @unique
  githubId        String?   @unique

  // University link
  universityId    String?
  university      University? @relation(fields: [universityId], references: [id])

  // Timestamps
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  registrations   Registration[]
  createdEvents   Event[]         @relation("EventCreator")
  sessions        Session[]
  notifications   Notification[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("sessions")
}

model Event {
  id               String        @id @default(cuid())
  title            String
  slug             String        @unique
  description      String        @db.Text
  shortDescription String?       @db.VarChar(300)
  bannerUrl        String?
  thumbnailUrl     String?
  category         EventCategory
  tags             String[]      @default([])
  startDate        DateTime
  endDate          DateTime
  registrationDeadline DateTime?
  venue            String?
  venueAddress     String?
  isOnline         Boolean       @default(false)
  onlineLink       String?
  maxAttendees     Int?
  currentAttendees Int            @default(0)
  isFree           Boolean       @default(true)
  price            Decimal?      @db.Decimal(10, 2)
  status           EventStatus   @default(DRAFT)
  isFeatured       Boolean       @default(false)
  universityId     String
  university       University    @relation(fields: [universityId], references: [id])
  createdById      String
  createdBy        User          @relation("EventCreator", fields: [createdById], references: [id])
  registrations    Registration[]
  googleSheetSync  GoogleSheetSync?
  publishedAt      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([category])
  @@index([universityId])
  @@index([status])
  @@index([startDate])
  @@map("events")
}

model Registration {
  id          String             @id @default(cuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  status      RegistrationStatus @default(PENDING)
  ticketCode  String             @unique @default(cuid())
  qrCodeUrl   String?
  checkedInAt DateTime?
  formData    Json?
  paymentId   String?
  paidAt      DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@unique([userId, eventId])
  @@index([eventId])
  @@index([userId])
  @@index([ticketCode])
  @@map("registrations")
}

model GoogleSheetSync {
  id              String    @id @default(cuid())
  eventId         String    @unique
  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  spreadsheetId   String
  sheetName       String    @default("Sheet1")
  formUrl         String?
  isAutoSync      Boolean   @default(false)
  syncIntervalMin Int       @default(15)
  lastSyncAt      DateTime?
  lastSyncStatus  String?
  lastSyncError   String?
  columnMapping   Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("google_sheet_syncs")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}